{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","fill","q","options","query","buildQueryParameters","targets","filter","t","hide","length","when","data","start","Number","range","from","toDate","getTime","toFixed","end","to","me","datasourceRequest","method","headers","then","result","dataQueryMapper","x","k","target","res","alias","perflabel","scopedVars","host","value","service","label","replace","datapoints","y","pop","undefined","push","response","status","message","title","interpolated","mapper","mapToTextValueHost","mapToTextValueService","mapToTextValuePerflabel","map","hosts","d","i","text","services","labels","refId"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.fill = instanceSettings.fill;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n  query(options) {\n    var query = this.buildQueryParameters(options);\n    query.targets = query.targets.filter(t => !t.hide);\n\n    if (query.targets.length <= 0) {\n      return this.q.when({data: []});\n    }\n\n    query.start = Number(options.range.from.toDate().getTime() / 1000).toFixed();\n    query.end   = Number(options.range.to.toDate().getTime() / 1000).toFixed();\n\n    var me = this;\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/index.php/api/metrics',\n      data: query,\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' }\n    }).then(function(result) { return(me.dataQueryMapper(result, options)) });\n  }\n\n  dataQueryMapper(result, options) {\n    var data = {data:[]};\n    for(var x=0; x < result.data.targets.length; x++) {\n      for(var k=0; k < result.data.targets[x].length; k++) {\n        var target = options.targets[x];\n        var res    = result.data.targets[x][k];\n        var alias = target.perflabel;\n        if(target.alias) {\n          alias = target.alias;\n          var scopedVars = {\n            host      : {value: res.host},\n            service   : {value: res.service},\n            perflabel : {value: res.perflabel},\n            label     : {value: res.perflabel}\n          };\n          alias = this.templateSrv.replace(alias, scopedVars);\n        }\n        var datapoints = res.datapoints;\n        var length     = datapoints.length;\n        // remove the last few \"null\" values from the series because the last value is quite often null\n        // and would break current value in legend tables\n        for(var y=1; y < 5; y++) {\n          if(length > y && datapoints[length-y][0] === null) {\n            datapoints.pop();\n          } else {\n            break;\n          }\n        }\n        var length = datapoints.length;\n        var fill   = options.targets[x].fill;\n        if(fill != \"fill\") {\n          if(fill == \"zero\") { fill = 0; }\n          if(fill == \"gap\")  { fill = undefined; }\n          for(var y=0; y<length; y++) {\n            if(datapoints[y][0] === null) {\n              datapoints[y][0] = fill;\n            }\n          }\n        }\n        data.data.push({\n          \"target\": alias,\n          \"datapoints\": datapoints\n        });\n      }\n    }\n    return(data);\n  }\n\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/index.php/api',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  metricFindQuery(options, type) {\n    var interpolated = {\n      host: this.templateSrv.replace(options.host, null, 'regex')\n    };\n\n    var mapper = this.mapToTextValueHost;\n    var url    = this.url + '/index.php/api/hosts';\n    if(type == \"service\") {\n      url    = this.url + '/index.php/api/services/'+options.host,\n      mapper = this.mapToTextValueService;\n    }\n    if(type == \"perflabel\") {\n      url    = this.url + '/index.php/api/labels/'+options.host+'/'+options.service,\n      mapper = this.mapToTextValuePerflabel;\n    }\n\n    return this.backendSrv.datasourceRequest({\n      url:     url,\n      data:    interpolated,\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' }\n    }).then(mapper);\n  }\n\n  mapToTextValueHost(result) {\n    return _.map(result.data.hosts, (d, i) => {\n      return { text: d.name, value: d.name };\n    });\n  }\n\n  mapToTextValueService(result) {\n    return _.map(result.data.services, (d, i) => {\n      return { text: d.name, value: d.name };\n    });\n  }\n\n  mapToTextValuePerflabel(result) {\n    return _.map(result.data.labels, (d, i) => {\n      return { text: d.name, value: d.name };\n    });\n  }\n\n  buildQueryParameters(options) {\n    //remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n      return target.host !== 'select host';\n    });\n    options.targets = _.filter(options.targets, target => {\n      return target.service !== 'select service';\n    });\n    options.targets = _.filter(options.targets, target => {\n      return target.perflabel !== 'select performance label';\n    });\n\n    var targets = _.map(options.targets, target => {\n      return {\n        host: this.templateSrv.replace(target.host),\n        service: this.templateSrv.replace(target.service),\n        perflabel: this.templateSrv.replace(target.perflabel),\n        alias: this.templateSrv.replace(target.alias),\n        type: this.templateSrv.replace(target.type),\n        fill: this.templateSrv.replace(target.fill),\n        refId: target.refId,\n        hide: target.hide\n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n}\n"]}